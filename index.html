<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Valve Case Viewer (3MF/STL)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { display: grid; grid-template-columns: 320px 1fr; grid-template-rows: auto 1fr; height: 100%; }
    header { grid-column: 1 / 3; padding: 10px 14px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
    header h1 { font-size: 16px; margin: 0; }
    #sidebar { padding: 12px; border-right: 1px solid #eee; overflow: auto; }
    #viewer { position: relative; background: #fafafa; }
    #canvas { position: absolute; inset: 0; }
    .block { margin-bottom: 14px; }
    .label { font-size: 12px; color: #666; margin-bottom: 6px; }
    select, button, input[type="checkbox"] { font-size: 14px; }
    .file-item { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .file-item label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
    .pill { border: 1px solid #ddd; padding: 6px 10px; border-radius: 999px; background: #fff; cursor: pointer; }
    .loading { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.95); border: 1px solid #ddd; border-radius: 8px; padding: 6px 10px; font-size: 12px; display: none; }
    footer { padding: 8px 12px; font-size: 12px; color: #888; border-top: 1px solid #eee; }
  </style>

  <!-- (Optional) Import maps shim for older browsers (e.g., older Safari) -->
  <script async src="https://ga.jspm.io/npm:es-module-shims@1.9.0/dist/es-module-shims.js"></script>

  <!-- Import map tells the browser what "three" means -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
    }
  }
  </script>

  <!-- (Optional) Quiet the favicon 404 -->
  <link rel="icon" href="data:,">
</head>
<body>
  <div id="app">
    <header>
      <h1>Valve Case Viewer</h1>
      <div class="toolbar">
        <button class="pill" id="fitBtn">Fit visible</button>
        <button class="pill" id="showAllBtn">Show all</button>
        <button class="pill" id="hideAllBtn">Hide all</button>
        <button class="pill" id="resetBtn">Reset view</button>
      </div>
      <div style="margin-left:auto; font-size:12px; color:#777;">
        Rotate: left-drag • Pan: right-drag • Zoom: wheel
      </div>
    </header>

    <aside id="sidebar">
      <div class="block">
        <div class="label">Case</div>
        <select id="caseSelect"></select>
      </div>

      <div class="block">
        <div class="label">Objects in this case (tick to show)</div>
        <div id="filesList"></div>
      </div>

      <footer>Tip: if something looks tiny or huge, click “Fit visible”.</footer>
    </aside>

    <main id="viewer">
      <div id="canvas"></div>
      <div class="loading" id="loading">Loading…</div>
    </main>
  </div>

  <!-- Three.js + loaders -->
  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { STLLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/STLLoader.js";
    import { ThreeMFLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/3MFLoader.js";

    // UI
    const caseSelect = document.getElementById('caseSelect');
    const filesList  = document.getElementById('filesList');
    const loadingEl  = document.getElementById('loading');
    const fitBtn     = document.getElementById('fitBtn');
    const showAllBtn = document.getElementById('showAllBtn');
    const hideAllBtn = document.getElementById('hideAllBtn');
    const resetBtn   = document.getElementById('resetBtn');

    // Three.js basics
    const container = document.getElementById('canvas');
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf8f9fb);

    const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 10000);
    camera.position.set(150, 150, 150);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    scene.add(new THREE.AmbientLight(0xffffff, 0.9));
    const dir = new THREE.DirectionalLight(0xffffff, 0.6);
    dir.position.set(1,1,1);
    scene.add(dir);

    const stlLoader = new STLLoader();
    const mfLoader  = new ThreeMFLoader();

    let currentGroup = null;
    const items = []; // {name, object3D, checkbox}

    function randomColor() {
      const hues = [0, 40, 200];
      const h = hues[Math.floor(Math.random() * hues.length)];
      return new THREE.Color().setHSL(h/360, 0.5, 0.55);
    }

    function clearScene() {
      if (!currentGroup) return;
      scene.remove(currentGroup);
      currentGroup.traverse(n => {
        if (n.isMesh) {
          n.geometry && n.geometry.dispose();
          if (n.material?.dispose) n.material.dispose();
        }
      });
      currentGroup = null;
      items.length = 0;
      filesList.innerHTML = "";
    }

    function fitToVisible(padding = 1.25) {
      if (!currentGroup) return;
      const box = new THREE.Box3();
      let hasVisible = false;
      currentGroup.traverse(n => {
        if (n.isMesh && n.visible) {
          const nb = new THREE.Box3().setFromObject(n);
          if (!hasVisible) { box.copy(nb); hasVisible = true; }
          else { box.union(nb); }
        }
      });
      if (!hasVisible) return;
      const size = new THREE.Vector3(); const center = new THREE.Vector3();
      box.getSize(size); box.getCenter(center);
      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = camera.fov * Math.PI/180;
      const dist = Math.abs(maxDim / (2 * Math.tan(fov/2))) * padding;
      camera.position.set(center.x + dist, center.y + dist, center.z + dist);
      controls.target.copy(center);
      controls.update();
    }

    function addFileRow(labelText, object3D) {
      const row = document.createElement('div');
      row.className = 'file-item';
      const id = 'chk_' + Math.random().toString(36).slice(2);
      row.innerHTML = `
        <input id="${id}" type="checkbox" checked />
        <label for="${id}">${labelText}</label>
      `;
      const chk = row.querySelector('input');
      chk.addEventListener('change', () => {
        object3D.visible = chk.checked;
      });
      filesList.appendChild(row);
      items.push({ name: labelText, object3D, checkbox: chk });
    }

    function loadModel(url) {
      const ext = url.split('.').pop().toLowerCase();
      return new Promise((resolve, reject) => {
        if (ext === 'stl') {
          stlLoader.load(url, geom => {
            geom.computeVertexNormals();
            const mesh = new THREE.Mesh(
              geom,
              new THREE.MeshStandardMaterial({ color: randomColor(), metalness: 0.1, roughness: 0.75 })
            );
            resolve(mesh);
          }, undefined, reject);
        } else if (ext === '3mf') {
          mfLoader.load(url, obj => {
            obj.traverse(n => {
              if (n.isMesh) {
                if (!n.material) n.material = new THREE.MeshStandardMaterial({ color: randomColor(), metalness: 0.1, roughness: 0.75 });
                n.castShadow = n.receiveShadow = false;
              }
            });
            resolve(obj);
          }, undefined, reject);
        } else {
          reject(new Error('Unsupported file: ' + ext));
        }
      });
    }

    async function loadCase(entry) {
      loadingEl.style.display = 'block';
      clearScene();

      const group = new THREE.Group();
      group.name = entry.id;

      for (const fname of entry.files) {
        const url = entry.basePath + fname;
        try {
          const obj = await loadModel(url);
          obj.name = fname;
          obj.visible = true; // start visible
          group.add(obj);
          addFileRow(fname, obj);
        } catch (e) {
          console.error('Failed to load', url, e);
        }
      }

      scene.add(group);
      currentGroup = group;
      fitToVisible();
      loadingEl.style.display = 'none';
    }

    async function init() {
      // Load cases list
      const res = await fetch('cases.json', { cache: 'no-store' });
      const data = await res.json();

      // Populate dropdown
      data.cases.forEach((c, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = c.name || c.id;
        caseSelect.appendChild(opt);
      });

      // Load first case
      await loadCase(data.cases[0]);

      // Change case
      caseSelect.addEventListener('change', () => {
        const idx = parseInt(caseSelect.value, 10);
        loadCase(data.cases[idx]);
      });

      // Buttons
      fitBtn.addEventListener('click', fitToVisible);
      showAllBtn.addEventListener('click', () => {
        items.forEach(it => { it.object3D.visible = true; it.checkbox.checked = true; });
        fitToVisible();
      });
      hideAllBtn.addEventListener('click', () => {
        items.forEach(it => { it.object3D.visible = false; it.checkbox.checked = false; });
      });
      resetBtn.addEventListener('click', () => {
        camera.position.set(150,150,150);
        controls.target.set(0,0,0);
        controls.update();
        fitToVisible();
      });
    }

    // Resize handling
    function onResize() {
      const w = container.clientWidth, h = container.clientHeight;
      renderer.setSize(w, h);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', onResize);

    // Render loop
    (function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    })();

    init().catch(err => {
      loadingEl.style.display = 'none';
      alert('Could not start viewer. Check cases.json and file paths.');
      console.error(err);
    });
  </script>
</body>
</html>
